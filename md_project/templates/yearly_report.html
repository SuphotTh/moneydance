{% extends "base.html" %}
{% load static %}

{% block title %}Yearly Report{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/30.0.6/ag-grid-community.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/30.0.6/styles/ag-grid.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/30.0.6/styles/ag-theme-alpine.min.css">

<!-- AG Grid CSS -->
<!-- <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css"> -->
<!-- <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css"> -->

<!-- AG Grid JavaScript -->
<!-- <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script> -->

<div class="container">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <h5 class="text text-primary">Yearly Report</h5>
                </div>
            </div>
            <form id="dataForm">
                {% csrf_token %}
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label for="selected_year" class="form-label">Select year:</label>
                        <select class='form-select form-select-sm' id="selected_year" name='selected_year'>
                            {% for y in year_array %}
                                <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="selected_type" class="form-label">Select type:</label>
                        <select class='form-select form-select-sm' id="selected_type" name='selected_type'>
                            <option value="Expenses">Expenses</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="selected_group" class="form-label">Select group:</label>
                        <select class='form-select form-select-sm' id="selected_group" name='selected_group'>
                            <option value="category">Category</option>
                            <option value="payee">Payee/Recipient</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Select tier:</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier1" name="tier" value="1" onclick="expenses_tier('1')">
                                <label class="form-check-label" for="tier1">: Tier 1</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier2" name="tier" value="2" onclick="expenses_tier('2')">
                                <label class="form-check-label" for="tier2">: Tier 2</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier3" name="tier" value="3" onclick="expenses_tier('3')">
                                <label class="form-check-label" for="tier3">: Tier 3</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier4" name="tier" value="4" onclick="expenses_tier('4')">
                                <label class="form-check-label" for="tier4">: Tier 4</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="content mt-2">    
    <h5 id='header' class='text text-primary'></h5>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="grid-container">
                    <div id="myGrid" class="ag-theme-alpine"></div>
                    <div id="popup-container" class="popup-container">
                        <div id="popup-content" class="popup-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .popup-container {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    }

    .popup {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .popup-content {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        font-size: 11px; /* Smaller font size */
        padding-top: 30px; /* Add some top padding to make room for the search box */
    }

    .popup-content h3 {
        position: absolute;
        font-size: 16px; /* Smaller font for the title */
        margin-bottom: 10px;
    }

    .popup-content .esc-hint {
        font-size: 11px;
        color: #666;
        text-align: center;
        margin-top: 10px;
    }

    .popup-table {
        width: 100%;
        border-collapse: collapse;
    }

    .popup-table th, .popup-table td {
        border: 1px solid #ddd;
        padding: 4px 6px;
        text-align: left;
    }

    .popup-table th {
        background-color: #f2f2f2;
        font-size: 12x;
    }

    .popup-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .popup-table .amount-cell {
        text-align: right;
        font-family: monospace; /* For better alignment of numbers */
    }

    #popupSearch {
        padding: 5px;
        margin-bottom: 10px;
        width: 200px;
        float: right;
    }

    .amount-cell {
        text-align: right;
    }
    .esc-hint {
        margin-top: 10px;
        text-align: right;
        font-style: italic;
        color: #888;
    }

    .grid-container {
    height: 500px;
    width: 100%;
    overflow: hidden;
    }

    #myGrid {
        width: 100%;
        height: 100%;
    }

    .ag-theme-alpine {
        --ag-font-size: 10px !important;
        --ag-font-family: Arial, sans-serif;
    }

    .ag-theme-alpine .ag-header-cell-label {
        font-weight: bold;
        font-size: 12px !important;
    }

    .ag-theme-alpine .ag-cell {
        padding-top: 1px !important;
        padding-bottom: 1px !important;
        line-height: 16px !important;
    }

    .ag-theme-alpine .ag-cell-value {
        font-size: 11px !important;
    }

    .ag-theme-alpine .ag-row {
        font-size: 11px !important;
    }

    .ag-theme-alpine .ag-row-even {
        background-color: #f8f8f8;
    }

    .ag-theme-alpine .ag-row-odd {
        background-color: #ffffff;
    }

    .ag-theme-alpine .ag-horizontal-left-spacer:not(.ag-scroller-corner) {
        overflow-x: scroll;
    }
</style>

<script>

function expenses_tier(selected_tier) {
    // Add check for AG Grid
    if (!window.agGrid) {
        console.error('AG Grid library not loaded. Please check your script imports.');
        return;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const year = document.getElementById('selected_year').value;
    const type = document.getElementById('selected_type').value;
    const group = document.getElementById('selected_group').value;
    const tier = selected_tier;

    const requestData = {
        tier: tier,
        type: type,
        group: group,
        year: year,
    };

    fetch('../yearly_report/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(requestData),
    })
    .then(response => response.json())
    .then(received_data => {
        const report_table = received_data.report_table;
        const transactions = received_data.transactions;

        const column_head = group === 'category' ? 'Category' : 'Payee/Recipient';
        
        createTable(year, column_head, report_table, transactions);
        // createTable(column_head, report_table, transactions);

        const combined_header = `${type} from: ${year - 5} to ${year} - Tier: ${tier}`;
        createHeader(combined_header);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

function createHeader(combined_header) {
    document.getElementById('header').innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;' + combined_header;
}

document.addEventListener('DOMContentLoaded', function() {
    // Check if AG Grid is loaded
    if (window.agGrid) {
        console.log('AG Grid loaded successfully');
        // Initialize your default view here if needed
    } else {
        console.error('AG Grid failed to load');
    }
});

window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
    return false;
};

function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

let gridApi = null;


function showPopup(data, transactions, column_head) {
    console.log("Attempting to show popup for:", data.category);
    console.log("Column head:", column_head);

    const popupContainer = document.getElementById('popup-container');
    const popupContent = document.getElementById('popup-content');
    if (!popupContainer || !popupContent) {
        console.error("Popup container or content not found in the DOM");
        return;
    }

    function formatAmount(amount) {
        return parseFloat(amount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    let popupContents = [];
    let category_or_payee_name = data.category;
    
    if (column_head == "Category") {
        popupContents = transactions.filter(rowData => rowData.category == category_or_payee_name)
            .map(rowData => ({
                date: rowData.date,
                payee: rowData.description,
                accountName: rowData.account_name,
                memo: rowData.memo,
                amount: rowData.amount
            }));
    } else if (column_head == 'Payee/Recipient') {
        popupContents = transactions.filter(rowData => rowData.description == category_or_payee_name)
            .map(rowData => ({
                date: rowData.date,
                category: rowData.category,
                accountName: rowData.account_name,
                memo: rowData.memo,
                amount: rowData.amount
            }));
    }

    if (popupContents.length === 0) {
        console.warn("No matching transactions found for the popup");
    }

    // Calculate the initial total amount
    let totalAmount = popupContents.reduce((sum, item) => sum + parseFloat(item.amount), 0);

    popupContents.sort((a, b) => new Date(a.date) - new Date(b.date));

    function createPopupHTML() {
        let popupHTML = `
            <h6>${column_head}: ${category_or_payee_name}</h6>
            <input type="text" id="popupSearch" placeholder="Search..." style="float: right; margin-bottom: 10px;">
            <p><strong>Total Amount: $<span id="totalAmount">${formatAmount(totalAmount)}</span></strong></p>
            <table class="popup-table">
                <thead>
                    <tr>
                        <th>YYYY/MM/DD</th>
                        <th>${column_head == "Category" ? "Payee" : "Category"}</th>
                        <th>Account Name</th>
                        <th>Memo</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="popupTableBody">
        `;

        popupContents.forEach(item => {
            popupHTML += `
                <tr>
                    <td>${item.date || ''}</td>
                    <td>${column_head == "Category" ? (item.payee || '') : (item.category || '')}</td>
                    <td>${item.accountName || ''}</td>
                    <td>${item.memo || ''}</td>
                    <td class="amount-cell">${formatAmount(item.amount || 0)}</td>
                </tr>
            `;
        });

        popupHTML += `
                </tbody>
            </table>
            <div class="esc-hint">Press ESC to close</div>
        `;

        return popupHTML;
    }

    try {
        popupContent.innerHTML = createPopupHTML();
        popupContainer.style.display = 'block';

        // Add ESC key listener
        document.addEventListener('keydown', handleEscKey);

        // Search functionality and recalculation of total
        const searchInput = document.getElementById('popupSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tbody = document.getElementById('popupTableBody');
                let filteredTotal = 0;

                if (tbody) {
                    const rows = tbody.getElementsByTagName('tr');
                    for (let row of rows) {
                        const text = row.textContent.toLowerCase();
                        const amountCell = row.querySelector('.amount-cell');
                        const amount = parseFloat(amountCell.textContent.replace(/[^0-9.-]+/g, "")); // Extract and parse amount

                        if (text.includes(searchTerm)) {
                            row.style.display = '';
                            filteredTotal += amount; // Sum visible row amounts
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }

                // Update total amount displayed
                document.getElementById('totalAmount').textContent = formatAmount(filteredTotal);
            });
        }

        console.log("Popup displayed successfully");
    } catch (error) {
        console.error("Error displaying popup:", error);
    }
}

function handleEscKey(event) {
    if (event.key === 'Escape') {
        closePopup();
    }
}

function closePopup() {
    const popupContainer = document.getElementById('popup-container');
    if (popupContainer) {
        popupContainer.style.display = 'none';
    }
    document.removeEventListener('keydown', handleEscKey);
}

function createTable(year, column_head, tableData, transactions) {
    if (gridApi) {
        gridApi.destroy();
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '';
        if (typeof value === 'number') {
            return value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
                useGrouping: true
            });
        }
        if (typeof value === 'string') {
            const numValue = parseFloat(value.replace(/[^0-9.-]+/g,""));
            if (!isNaN(numValue)) {
                return Math.round(numValue).toLocaleString('en-US', {
                    useGrouping: true
                });
            }
        }
        return value;
    }

    function parseValue(value) {
        if (value === null || value === undefined) return 0;
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            return parseFloat(value.replace(/[^0-9.-]+/g,"")) || 0;
        }
        return 0;
    }

    const yearRange = Array.from({length: 6}, (_, i) => year - 5 + i);
    
    const columnDefs = [
        { 
            field: 'category', 
            headerName: column_head, 
            width: 150, 
            pinned: 'left', 
            filter: true
        },
        { 
            field: 'tier', 
            headerName: 'T', 
            width: 40,
        },
        ...['year6', 'year5', 'year4', 'year3', 'year2', 'year1', 'total'].map((year, index) => ({
            field: year,
            headerName: year === 'total' ? 'Total' : 'Y'+yearRange[index].toString(),
            width: year === 'total' ? 100 : 80,
            type: 'numericColumn',
            valueGetter: params => parseValue(params.data[year]),
            valueFormatter: params => formatNumber(params.value),
            sortable: true,
            sort: year === 'total' ? 'desc' : null,
        }))
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        rowData: tableData,
        defaultColDef: {
            sortable: true,
            resizable: true,
        },
        onCellClicked: function(params) {
            if (params.column.getColId() === 'category') {
                showPopup(params.data, transactions, column_head);
            }
        },
        getRowStyle: function(params) {
            if (params.data && params.data.tier === "1") {
                return { fontWeight: 'bold' };
            }
        },
        pinnedBottomRowData: [generateTotalsRow(tableData)],
        onGridReady: function(params) {
            params.api.sizeColumnsToFit();
            console.log('Grid is ready');
        },
        domLayout: 'normal', // Change this from 'autoHeight'
        rowHeight: 18,
        headerHeight: 25,
    };

    const gridDiv = document.querySelector('#myGrid');
    gridDiv.style.height = '500px'; // Set a fixed height for the grid
    gridDiv.style.width = '100%';
    
    // const grid = new agGrid.Grid(gridDiv, gridOptions);
    // gridApi = grid.gridOptions.api;
    
    try {
        // Check if agGrid is properly loaded
        if (!window.agGrid) {
            console.error('AG Grid library not loaded');
            return;
        }
        
        // Create new grid instance
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
        
        // Add error handling for grid creation
        if (!gridApi) {
            console.error('Failed to create grid');
            return;
        }

        console.log('Grid created successfully');
    } catch (error) {
        console.error('Error creating grid:', error);
    }

    // ... (rest of the function remains the same)

    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .ag-theme-alpine {
            --ag-font-size: 10px !important;
            --ag-font-family: Arial, sans-serif;
        }
        .ag-theme-alpine .ag-header-cell-label {
            font-weight: bold;
            font-size: 12px !important;
        }
        .ag-theme-alpine .ag-cell {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
            line-height: 16px !important;
        }
        .ag-theme-alpine .ag-cell-value {
            font-size: 12px !important;
        }
        .ag-theme-alpine .ag-row {
            font-size: 12px !important;
        }
        .ag-theme-alpine .ag-row-even {
            background-color: #f8f8f8;
        }
        .ag-theme-alpine .ag-row-odd {
            background-color: #ffffff;
        }
                    .sticky-col {
            position: sticky;
            background-color: inherit !important;
            z-index: 1;
        }
    `;
    document.head.appendChild(styleElement);

    setTimeout(() => {
        gridApi.resetRowHeights();
        gridApi.sizeColumnsToFit();
    }, 0);

    console.log('Grid created with updated styles');
}

function generateTotalsRow(rowData) {
    const totals = { category: 'Total', tier: '' };
    ['year6', 'year5', 'year4', 'year3', 'year2', 'year1', 'total'].forEach(year => {
        totals[year] = rowData.reduce((sum, row) => {
            return sum + parseValue(row[year]);
        }, 0);
    });
    return totals;
}

function parseValue(value) {
    if (value === 'Invalid ...' || value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        if (value.endsWith('...')) {
            return parseFloat(value) || 0;
        }
        return parseFloat(value.replace(/[^0-9.-]+/g,"")) || 0;
    }
    return 0;
}
</script>
{% endblock %}