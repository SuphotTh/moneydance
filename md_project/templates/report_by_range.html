{% extends 'base.html' %}

{% block title %}Report by date{% endblock %}

{% block content %}
<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">

<!-- AG Grid JavaScript -->
<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>

<div class="container">
    <div class="card">
        <div class="card-body">
            <h5 class="text text-primary">{{ header }}</h5>
            <form id="dataForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-2">
                        <label for="start_date"> Custom date </label>
                        <input class="date form-control form-control-sm" size="11"
                            type="date" name="start_date" id="start_date" value="{{custom_date.0}}" required>
                    </div>
                    <div class="col-2">
                        <label for="end_date"> To </label>
                        <input class="date form-control form-control-sm" size="11"
                        type="date" name="end_date" id="end_date" value="{{custom_date.1}}" required>
                    </div>
                    <div class="col-1"></div>
                    <div class="col-2">
                        <input type="radio" id="option1" name="options" value="custom_date" checked >
                        <label for="option1">: Custom date</label>
                    </div>
                    <div class="col-2">
                        <input type="radio" id="option2" name="options" value="last_month" >
                        <label for="option2">: Last month</label>                  
                    </div>
                    <div class="col-2">
                        <input type="radio" id="option3" name="options" value="last_3months" >
                        <label for="option3">: Last 3 months</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-5"></div>
                    <div class="col-2">
                        <input type="radio" id="option4" name="options" value="last_12months" >
                        <label for="option4">: Last 12 months</label>
                    </div>
                    <div class="col-2">
                        <input type="radio" id="option5" name="options" value="last_year" >
                        <label for="option5">: Last year</label>
                    </div>
                    <div class="col-2">
                        <input type="radio" id="option6" name="options" value="ytd" >
                        <label for="option6">: Year to date</label>
                    </div>
                </div>
                <hr>

                <div class="row">
                    <div class="col-2">
                        <label class="form-label">Select tier:</label>&nbsp&nbsp&nbsp&nbsp
                    </div>
                    <div class="col-1">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="tier1" name="tier" value="1" onclick="expenses_tier('1')">
                            <label class="form-check-label" for="tier1">:Tier1</label>
                        </div>
                    </div>
                    <div class="col-1">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="tier2" name="tier" value="2" onclick="expenses_tier('2')">
                            <label class="form-check-label" for="tier2">:Tier2</label>
                        </div>
                    </div>
                    <div class="col-1">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="tier3" name="tier" value="3" onclick="expenses_tier('3')">
                            <label class="form-check-label" for="tier3">:Tier3</label>
                        </div>
                    </div>
                    <div class="col-1">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="tier4" name="tier" value="4" onclick="expenses_tier('4')">
                            <label class="form-check-label" for="tier4">:Tier4</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .ag-theme-alpine {
        --ag-font-size: 10px !important;
        --ag-font-family: Arial, sans-serif;
    }
    .ag-theme-alpine .ag-header-cell-label {
        font-weight: bold;
        font-size: 12px !important;
    }
    .ag-theme-alpine .ag-cell {
        padding-top: 1px !important;
        padding-bottom: 1px !important;
        line-height: 16px !important;
    }
    .ag-theme-alpine .ag-cell-value {
        font-size: 12px !important;
    }
    .ag-theme-alpine .ag-row {
        font-size: 12px !important;
    }
    .ag-theme-alpine .ag-row-even {
        background-color: #f8f8f8;
    }
    .ag-theme-alpine .ag-row-odd {
        background-color: #ffffff;
    }
</style>
<div class="content mt-2">    
    <h5 id='header' class='text text-primary'></h5>
    <div class="container">
        <div class="row">
            <div class="col-6">
                <div id="income_table" class="ag-theme-alpine" style="height: 450px; width:100%;"></div>
            </div>
            <div class="col-6">
                <div id="expenses_table" class="ag-theme-alpine" style="height: 450px; width:100%;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variable to track AG Grid availability
let isAgGridLoaded = false;

// Function to wait for AG Grid to load
function waitForAgGrid() {
    return new Promise((resolve, reject) => {
        const checkInterval = setInterval(() => {
            if (window.agGrid) {
                clearInterval(checkInterval);
                resolve(true);
            }
        }, 100);

        // Timeout after 5 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            reject(new Error('AG Grid failed to load'));
        }, 5000);
    });
}

function expenses_tier(selected_tier) {
    //Clear Screen 
    clearReportContent();

    // Get CSRF token from the form
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Get start date and end date from the input fields
    const start_date = document.getElementById('start_date').value;
    const end_date = document.getElementById('end_date').value;

    // Get selected date range option from radio buttons (checked)
    const date_selection = document.querySelector('input[name="options"]:checked').value;

    // Selected tier is passed to the function as an argument
    const tier = selected_tier;

    // Log values for debugging
    console.log("Selected start date:", start_date);
    console.log("Selected end date:", end_date);
    console.log("Selected date range option:", date_selection);
    console.log("Selected tier:", tier);

    // Prepare the data to be sent in the request
    const requestData = {
        start_date: start_date,
        end_date: end_date,
        selected_tier: tier,
        date_selection: date_selection,
    };

    fetch('../report_by_range/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(requestData),
    })
    .then(response => response.json())
    .then(received_data => {
        // console.log('Received data:', received_data);
        table_data = received_data;
        income_data = received_data.income_data;
        expenses_data = received_data.expenses_data;

        console.log('inc data XX:', income_data);
        //console.log('inc u data:', income_data_unselected);
        console.log('exp data XX:', expenses_data);
        console.log('AG GRID : ', agGrid);

        //console.log('exp u data:', expenses_data_unselected); 

        const date_info = received_data.date_info;
        //console.log(typeof(date_info));
        console.log("date info : ",date_info);
        const s_date = date_info.start_date;
        const e_date = date_info.end_date;

        //console.log('table_data.length');
        //console.log(typeof(table_data));
        income_data = table_data.income_data;
        expenses_data = table_data.expenses_data;
        createSummaryTable(income_data, expenses_data);

        combined_header = "  "+date_selection + " : " + s_date + " - " +e_date;
        createHeader(combined_header);

    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

function clearReportContent() {
    // Clear the income table
    const incomeTable = document.getElementById('income_table');
    if (incomeTable) {
        while (incomeTable.firstChild) {
            incomeTable.removeChild(incomeTable.firstChild);
        }
    }

    // Clear the expenses table
    const expensesTable = document.getElementById('expenses_table');
    if (expensesTable) {
        while (expensesTable.firstChild) {
            expensesTable.removeChild(expensesTable.firstChild);
        }
    }

    // Clear the header
    const header = document.getElementById('header');
    if (header) {
        header.innerHTML = '';
    }
}

function formattedNumber(input) {
    let output = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(input);
    return output;
}

function createHeader(combined_header) {
    document.getElementById('header').innerHTML = '&nbsp&nbsp&nbsp&nbsp report : '
        + combined_header ;
}

function consoleLog(name, variable) {
    console.log(name);
    console.log(variable);
}

function createSummaryTable(income_data, expenses_data) {
    // Check if AG Grid is loaded before proceeding
    if (!window.agGrid) {
        console.error('AG Grid is not loaded');
        return;
    }

    if ((income_data && Object.keys(income_data).length > 0) || 
        (expenses_data && Object.keys(expenses_data).length > 0)) {
        function createDataTable(data_in) {
            let category1 = '';
            let tier_number = null;
            let sub_total = 0;
            let tabulator_table = [];
            
            data_in.forEach((rowData, index) => {
                if (category1 !== rowData.category) {
                    if (category1 !== '') {
                        tabulator_table.push({
                            category: category1,
                            tier_number: tier_number,
                            amount: sub_total
                        });
                    }
                    category1 = rowData.category;
                    tier_number = rowData.tier_number;
                    sub_total = 0;
                }
                sub_total += parseFloat(rowData.amount);
                
                if (index === data_in.length - 1) {
                    tabulator_table.push({
                        category: category1,
                        tier_number: tier_number,
                        amount: sub_total
                    });
                }
            });
            
            return tabulator_table;
        }

        const income_table = createDataTable(income_data);
        const expenses_table = createDataTable(expenses_data);

        createTable("income_table", income_table);
        createTable("expenses_table", expenses_table);
    } else {
        document.getElementById("income_table").innerHTML = "No data for this range of date";
        document.getElementById("expenses_table").innerHTML = "";
    }
}

function showPopup(data, transactions, columnHead) {
    // Remove existing popup if any
    const existingPopup = document.getElementById('cellPopup');
    if (existingPopup) {
        existingPopup.remove();
    }

    // Filter transactions by category
    const categoryTransactions = transactions.filter(t => t.category === data.category);

    // Create popup element
    const popup = document.createElement('div');
    popup.id = 'cellPopup';
    popup.style.cssText = `
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 1px solid #ccc;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        width: 50%;
        max-height: 60%;
        overflow-y: auto;
        font-size: 12px;
        font-family: Arial, sans-serif;
    `;

    // Determine whether it's income or expenses
    let popupHead = '';
    if (columnHead === 'income_table') {
        popupHead = 'Income';
    } else if (columnHead === 'expenses_table') {
        popupHead = 'Expenses';
    }

    // Calculate total amount for all category transactions
    let totalAmount = categoryTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);

    // Create popup content
    let popupContent = `
        <h3 style="font-size: 14px; margin-bottom: 8px;"> Type - ${popupHead}, Category - ${data.category}</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <p style="margin: 0;"><strong>Total Amount:</strong> <span id="totalAmountDisplay">${formattedNumber(totalAmount)}</span></p>
            <input type="text" id="searchBox" placeholder="Search..." style="padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px;">
        </div>
        <h4 style="font-size: 12px; margin-bottom: 8px;">Transactions:</h4>
        <table id="transactionTable" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 6px; text-align: left; background-color: #f2f2f2;">Date</th>
                    <th style="border: 1px solid #ddd; padding: 6px; text-align: left; background-color: #f2f2f2;">Description</th>
                    <th style="border: 1px solid #ddd; padding: 6px; text-align: left; background-color: #f2f2f2;">Memo</th>
                    <th style="border: 1px solid #ddd; padding: 6px; text-align: right; background-color: #f2f2f2;">Amount</th>
                </tr>
            </thead>
            <tbody>
    `;

    // Add transactions to table
    categoryTransactions.forEach(t => {
        popupContent += `
            <tr>
                <td style="border: 1px solid #ddd; padding: 6px;">${t.date}</td>
                <td style="border: 1px solid #ddd; padding: 6px;">${t.description}</td>
                <td style="border: 1px solid #ddd; padding: 6px;">${t.memo}</td>
                <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${formattedNumber(t.amount)}</td>
            </tr>
        `;
    });

    popupContent += `
            </tbody>
        </table>
        <div style="text-align: center; margin-top: 12px;">
            <p style="font-size: 9px; color: #666;">Press ESC to close</p>
        </div>
    `;

    popup.innerHTML = popupContent;
    document.body.appendChild(popup);

    // Add ESC key listener to close popup
    const escKeyListener = (event) => {
        if (event.key === 'Escape') {
            popup.remove();
            document.removeEventListener('keydown', escKeyListener);
        }
    };
    document.addEventListener('keydown', escKeyListener);

    // Search and filter transactions
    document.getElementById('searchBox').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#transactionTable tbody tr');
        let filteredTotal = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                // Extract the amount from the displayed row and add to filteredTotal
                const amount = parseFloat(row.cells[3].textContent.replace(/[^0-9.-]+/g, ""));
                filteredTotal += amount;
            } else {
                row.style.display = 'none';
            }
        });

        // Update the total displayed in the popup
        document.getElementById('totalAmountDisplay').textContent = formattedNumber(filteredTotal);
    });
}


let gridApi = null; // Global variable to hold the grid API

function createTable(tableId, tableData) {
    // Ensure AG Grid is available
    if (!window.agGrid) {
        console.error('AG Grid is not available');
        return;
    }

    // Destroy existing grid if it exists
    const gridDiv = document.querySelector(`#${tableId}`);
    if (gridDiv && gridDiv.gridApi) {
        gridDiv.gridApi.destroy();
    }

    // Calculate total
    const total = tableData.reduce((sum, row) => sum + row.amount, 0);

    const gridOptions = {
        columnDefs: [
            { 
                field: 'category', 
                headerName: tableId.replace('_table', '').charAt(0).toUpperCase() + tableId.replace('_table', '').slice(1),  
                flex: 1,
                valueFormatter: params => {
                    if (params.value) {
                        return params.value.charAt(0).toUpperCase() + params.value.slice(1);
                    }
                    return params.value;
                }
            },
            { 
                field: 'tier_number', 
                headerName: 'Tier', 
                type: 'numericColumn', 
                flex: 1,
                cellStyle: { textAlign: 'right' }
            },
            { 
                field: 'amount', 
                headerName: 'Amount', 
                type: 'numericColumn', 
                flex: 1,
                valueFormatter: params => formattedNumber(params.value),
                cellStyle: { textAlign: 'right' },
                sort: 'desc',
            }
        ],
        rowData: tableData,
        defaultColDef: {
            sortable: true,
            filter: true
        },
        domLayout: 'normal',
        suppressHorizontalScroll: true,
        getRowStyle: params => {
            if (params.node.rowIndex % 2 === 0) {
                return { background: '#f8f8f8' };
            }
        },
        rowHeight: 25,
        pinnedBottomRowData: [{ category: 'Total', amount: total }],
        getRowClass: (params) => {
            if (params.node.rowPinned === 'bottom') {
                return 'total-row';
            }
        },
        maintainColumnOrder: true,
        onCellClicked: function(params) {
            if (params.column.getColId() === 'category' && params.node.rowPinned !== 'bottom') {
                if (tableId == 'income_table') {
                    showPopup(params.data, income_data, tableId);
                } else if (tableId == 'expenses_table') {
                    showPopup(params.data, expenses_data, tableId);    
                }
            }
        }
    };

    try {
        // Use Grid initialization that works with latest AG Grid versions
        const gridInstance = agGrid.createGrid(gridDiv, gridOptions);
        
        // Attach grid API to the div for potential future reference
        gridDiv.gridApi = gridInstance;
    } catch (error) {
        console.error('Error creating AG Grid:', error);
    }
}

// Event listener to handle clicks outside popup
document.addEventListener('click', function(event) {
    const popup = document.getElementById('cellPopup');
    if (popup && !popup.contains(event.target) && !event.target.closest('.ag-cell')) {
        popup.remove();
    }
});

// Ensure AG Grid is loaded before enabling interactions
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await waitForAgGrid();
        console.log('AG Grid is loaded and ready');
    } catch (error) {
        console.error('Failed to load AG Grid:', error);
    }
});

</script>
{% endblock %}