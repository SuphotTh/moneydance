{% extends "base.html" %}
{% load static %}

{% block title %}Monthly Report{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <h5 class="text text-primary">Monthly Report</h5>
                </div>
            </div>
            <form id="dataForm">
                {% csrf_token %}
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label for="selected_year" class="form-label">Select year:</label>
                        <select class='form-select form-select-sm' id="selected_year" name='selected_year'>
                            {% for y in year_array %}
                                <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="selected_type" class="form-label">Select type:</label>
                        <select class='form-select form-select-sm' id="selected_type" name='selected_type'>
                            <option value="Expenses">Expenses</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="selected_group" class="form-label">Select group:</label>
                        <select class='form-select form-select-sm' id="selected_group" name='selected_group'>
                            <option value="category">Category</option>
                            <option value="payee">Payee/Recipient</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Select tier:</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier1" name="tier" value="1" onclick="expenses_tier('1')">
                                <label class="form-check-label" for="tier1">: Tier 1</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier2" name="tier" value="2" onclick="expenses_tier('2')">
                                <label class="form-check-label" for="tier2">: Tier 2</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier3" name="tier" value="3" onclick="expenses_tier('3')">
                                <label class="form-check-label" for="tier3">: Tier 3</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="tier4" name="tier" value="4" onclick="expenses_tier('4')">
                                <label class="form-check-label" for="tier4">: Tier 4</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .popup {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .popup-content {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        font-size: 11px; /* Smaller font size */
        padding-top: 30px; /* Add some top padding to make room for the search box */
    }

    .popup-content h3 {
        position: absolute;
        font-size: 16px; /* Smaller font for the title */
        margin-bottom: 10px;
    }

    .popup-content .esc-hint {
        font-size: 11px;
        color: #666;
        text-align: center;
        margin-top: 10px;
    }

    .popup-table {
        width: 100%;
        border-collapse: collapse;
    }

    .popup-table th, .popup-table td {
        border: 1px solid #ddd;
        padding: 4px 6px;
        text-align: left;
    }

    .popup-table th {
        background-color: #f2f2f2;
        font-size: 12x;
    }

    .popup-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .popup-table .amount-cell {
        text-align: right;
        font-family: monospace; /* For better alignment of numbers */
    }

    #popupSearch {
        padding: 5px;
        margin-bottom: 10px;
        width: 200px;
        float: right;
    }


    /* ... (rest of the styles remain the same) ... */
</style>

<div class="content mt-2">
    <h5 id='header' class='text-primary mb-3'></h5>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div id="myGrid" class="ag-theme-alpine" style="width:100%;"></div>
                <div id="popup-container" class="popup"></div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">
<!-- AG Grid CSS -->

<script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
<!-- AG Grid JavaScript -->

<script>
function expenses_tier(selected_tier) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const year = document.getElementById('selected_year').value;
    const type = document.getElementById('selected_type').value;
    const group = document.getElementById('selected_group').value;
    const tier = selected_tier;
    //const tier = document.querySelector('input[name="tier"]:checked').value;

    console.log(type);
    console.log("Selected tier:", tier);
    console.log(year);
    console.log(group);

    const requestData = {
        // Add any parameters you need for fetching data
        tier : tier,
        type : type,
        group : group,
        year : year,
    };

    fetch('../monthly_report/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(requestData),
    })
    .then(response => response.json())
    .then(received_data => {
        console.log('Received data:', received_data);
        report_table = received_data.report_table;
        console.log('type of report_table ', typeof(report_table))
        console.log('report_table ',report_table);

        transactions = received_data.transactions;
        console.log('type of transactions', typeof(transactions))
        console.log('transactions', transactions);
        console.log(typeof(transactions))

        column_head = '';
        if (group == 'category') {
            column_head = 'Category';
        } else if (group == 'payee') {
            column_head = 'Payee/Recipiant';
        }        
     
        createTable(column_head, report_table, transactions);

        combined_header = "  "+ type + " report&nbsp,&nbsp&nbspYear : " + year + " for " + type + " of Tier : " + tier;
        createHeader(combined_header);

    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

function createHeader(combined_header) {
    document.getElementById('header').innerHTML = '&nbsp&nbsp&nbsp&nbsp '
        + combined_header ;
}

document.addEventListener('DOMContentLoaded', function() {
    // Your existing initialization code...

    // Add event listener for ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closePopup();
        }
    });
});

function showPopup(data, transactions, column_head) {
    console.log("data.category is:", data.category);
    console.log("column_head is", column_head);

    function formatAmount(amount) {
        return parseFloat(amount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    let popupContents = [];
    let category_or_payee_name = data.category;
    
    if (column_head == "Category") {
        popupContents = transactions.filter(rowData => rowData.category == category_or_payee_name)
            .map(rowData => ({
                date: rowData.date,
                payee: rowData.description,
                accountName: rowData.account_name,
                memo: rowData.memo,
                amount: rowData.amount
            }));
    } else if (column_head == 'Payee/Recipiant') {
        popupContents = transactions.filter(rowData => rowData.description == category_or_payee_name)
            .map(rowData => ({
                date: rowData.date,
                category: rowData.category,
                accountName: rowData.account_name,
                memo: rowData.memo,
                amount: rowData.amount
            }));
    }

    // Sort popupContents by date in ascending order
    popupContents.sort((a, b) => new Date(a.date) - new Date(b.date));

    function createPopupHTML() {
        let popupHTML = `
            <div class="popup-content">
                <h3>${column_head}: ${category_or_payee_name}</h3>
                <input type="text" id="popupSearch" placeholder="Search..." style="float: right; margin-bottom: 10px;">
                <table class="popup-table">
                    <thead>
                        <tr>
                            <th>YYYY/MM/DD</th>
                            <th>${column_head == "Category" ? "Payee" : "Category"}</th>
                            <th>Account Name</th>
                            <th>Memo</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="popupTableBody">
        `;

        popupContents.forEach(item => {
            popupHTML += `
                <tr>
                    <td>${item.date}</td>
                    <td>${column_head == "Category" ? item.payee : item.category}</td>
                    <td>${item.accountName}</td>
                    <td>${item.memo}</td>
                    <td class="amount-cell">${formatAmount(item.amount)}</td>
                </tr>
            `;
        });

        popupHTML += `
                    </tbody>
                </table>
                <div class="esc-hint">Press ESC to close</div>
            </div>
        `;

        return popupHTML;
    }

    // Display the popup
    document.getElementById('popup-container').innerHTML = createPopupHTML();
    document.getElementById('popup-container').style.display = 'block';

    // Add event listener for ESC key
    document.addEventListener('keydown', handleEscKey);

    // Add event listener for search
    document.getElementById('popupSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const tbody = document.getElementById('popupTableBody');
        const rows = tbody.getElementsByTagName('tr');

        for (let row of rows) {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        }
    });
}

function handleEscKey(event) {
    if (event.key === 'Escape') {
        closePopup();
    }
}

function closePopup() {
    document.getElementById('popup-container').style.display = 'none';
    document.removeEventListener('keydown', handleEscKey);
}

let gridApi = null; // Global variable to hold the grid API

function createTable(column_head, tableData, transactions) {
    if (gridApi) {
        gridApi.destroy();
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '';
        if (typeof value === 'number') {
            return value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
                useGrouping: true
            });
        }
        if (typeof value === 'string') {
            const numValue = parseFloat(value.replace(/[^0-9.-]+/g,""));
            if (!isNaN(numValue)) {
                return Math.round(numValue).toLocaleString('en-US', {
                    useGrouping: true
                });
            }
        }
        return value;
    }

    function parseValue(value) {
        if (value === null || value === undefined) return 0;
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            return parseFloat(value.replace(/[^0-9.-]+/g,"")) || 0;
        }
        return 0;
    }

    const columnDefs = [
        { 
            field: 'category', 
            headerName: column_head, 
            width: 150, 
            pinned: 'left', 
            filter: true,
            cellClass: 'sticky-col'
        },
        { 
            field: 'tier', 
            headerName: 'T', 
            width: 40,
            pinned: 'left',
            cellClass: 'sticky-col'
        },
        ...['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'total'].map(month => ({
            field: month,
            headerName: month.charAt(0).toUpperCase() + month.slice(1),
            width: month === 'total' ? 100 : 80,
            type: 'numericColumn',
            valueGetter: params => parseValue(params.data[month]),
            valueFormatter: params => formatNumber(params.value),
            sortable: true,
            sort: month === 'total' ? 'desc' : null,
        }))
    ];

    const gridOptions = {
        columnDefs: columnDefs,
        rowData: tableData,
        defaultColDef: {
            sortable: true,
            resizable: true,
        },
        onCellClicked: function(params) {
            if (params.column.getColId() === 'category') {
                showPopup(params.data, transactions, column_head);
            }
        },
        getRowStyle: function(params) {
            if (params.data && params.data.tier === "1") {
                return { fontWeight: 'bold' };
            }
        },
        pinnedBottomRowData: [generateTotalsRow(tableData)],
        onGridReady: function(params) {
            params.api.sizeColumnsToFit();
            console.log('Grid is ready');
        },
        domLayout: 'normal',
        rowHeight: 18,
        headerHeight: 25,
        suppressHorizontalScroll: false,
    };

    const gridDiv = document.querySelector('#myGrid');
    gridDiv.style.height = '500px'; // Set a fixed height for the grid container
    gridDiv.style.width = '100%';
    const grid = new agGrid.Grid(gridDiv, gridOptions);
    gridApi = grid.gridOptions.api;

    // Apply custom styles
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .ag-theme-alpine {
            --ag-font-size: 10px !important;
            --ag-font-family: Arial, sans-serif;
        }
        .ag-theme-alpine .ag-header-cell-label {
            font-weight: bold;
            font-size: 11px !important;
        }
        .ag-theme-alpine .ag-cell {
            padding-top: 1px !important;
            padding-bottom: 1px !important;
            line-height: 16px !important;
        }
        .ag-theme-alpine .ag-cell-value {
            font-size: 11px !important;
        }
        .ag-theme-alpine .ag-row {
            font-size: 11px !important;
        }
        .ag-theme-alpine .ag-row-even {
            background-color: #f8f8f8;
        }
        .ag-theme-alpine .ag-row-odd {
            background-color: #ffffff;
        }
        .sticky-col {
            position: sticky;
            background-color: inherit !important;
            z-index: 1;
        }
    `;
    document.head.appendChild(styleElement);

    // Force refresh of grid to apply new styles
    setTimeout(() => {
        gridApi.resetRowHeights();
        gridApi.sizeColumnsToFit();
    }, 0);

    console.log('Grid created with updated styles');
    // If you need to access the grid API later, you can use:
    // const gridApi = gridOptions.api;
    // const columnApi = gridOptions.columnApi;

}

function generateTotalsRow(rowData) {
    const totals = { category: 'Total', tier: '' };
    ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'total'].forEach(month => {
        totals[month] = rowData.reduce((sum, row) => {
            return sum + parseValue(row[month]);
        }, 0);
    });
    return totals;
}

function parseValue(value) {
    if (value === 'Invalid ...' || value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        if (value.endsWith('...')) {
            return parseFloat(value) || 0;
        }
        return parseFloat(value.replace(/[^0-9.-]+/g,"")) || 0;
    }
    return 0;
}

</script>
{% endblock %}