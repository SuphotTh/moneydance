{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-2">
  <h5>ðŸ“Š Stock Purchase Report</h5>

  <!-- Symbol Selection -->
  <div class="mb-3 d-flex align-items-center mb-2">
      <label for="symbolSelect" class="form-label me-2 mb-0">Select Symbol:</label>
      <select id="symbolSelect" class="form-select" style="width: 150px;">
        <option value="">-- Choose Symbol --</option>
        {% for s in symbols %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
  </div>
  <!-- Report Table -->
  <div id="reportSection" class="mt-3" style="display:none;">
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Symbol</th>
          <th>Date</th>
          <th>Time</th>
          <th>Order No</th>
          <th>Side</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Comm</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>

    <div class="d-flex justify-content-between">
      <button id="prevBtn" class="btn btn-outline-secondary btn-sm">Previous</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next</button>
    </div>
    <!-- Summary -->
    <div class="mt-2 d-flex justify-content-around align-items-center border p-2 rounded bg-light">
      <p class="mb-0"><strong>Last Price: </strong> <span id="accLastPrice"></span></p>
      <p class="mb-0"><strong>Total Qty: </strong> <span id="accTotalQty"></span></p>
      <p class="mb-0"><strong>Value: </strong> <span id="accTotalValue"></span></p>
      <p class="mb-0"><strong>Total Cost:</strong> <span id="totalCost"></span></p>
      <p class="mb-0"><strong>P&L:</strong> <span id="pnl"></span> / <span id="percent"></span>%</p>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
const reportSection = document.getElementById('reportSection');
const symbolSelect = document.getElementById('symbolSelect');

window.addEventListener('DOMContentLoaded', () => {
  symbolSelect.value = "AAPL80";
  loadReport();
});

symbolSelect.addEventListener('change', () => {
  currentPage = 1;
  loadReport();
});

document.getElementById('prevBtn').addEventListener('click', () => {
  if (currentPage > 1) { currentPage--; loadReport(); }
});

document.getElementById('nextBtn').addEventListener('click', () => {
  currentPage++; loadReport();
});

function loadReport() {
  const sym = symbolSelect.value || "AAPL80";

  fetch(`/purchase_stock_report/?sym=${sym}&page=${currentPage}`)
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById('reportBody');

      if (!data.page_obj || data.page_obj.length === 0) {
        reportSection.style.display = 'block';
        tbody.innerHTML = '<tr><td colspan="12" class="text-center">No data</td></tr>';
        document.getElementById('accTotalQty').innerText = '0.00';
        document.getElementById('accTotalValue').innerText = '0.00';
        document.getElementById('accLastPrice').innerText = '0.00';
        document.getElementById('totalCost').innerText = '0.00';
        document.getElementById('pnl').innerText = '0.00';
        document.getElementById('percent').innerText = '0.00';
        document.getElementById('pageInfo').innerText = '';
        return;
      }

      reportSection.style.display = 'block';
      tbody.innerHTML = '';
      total_cost = 0
      total_qty = 0
      data.page_obj.forEach(r => {
        cost = 0
        if (r.side == "Sell") { 
            r.qty = r.qty * -1
        }
        commission_plus = r.brokerage_fee + r.trading_fee + r.clearing_fee
        cost = (r.qty * r.price) + commission_plus
        tbody.innerHTML += `
          <tr>
            <td>${r.id}</td>
            <td>${r.symbol}</td>
            <td>${r.date}</td>
            <td>${r.time}</td>
            <td>${r.order_no}</td>
            <td>${r.side}</td>
            <td class="text-end">${Number(r.qty).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end">${Number(r.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end">${Number(commission_plus).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end">${Number(cost).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          </tr>`;
        total_qty += r.qty
        total_cost += cost
        });

      document.getElementById('accTotalQty').innerText = Number(data.acc_total_qty).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('accTotalValue').innerText = Number(data.acc_total_value).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('accLastPrice').innerText = Number(data.acc_last_price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('totalCost').innerText = Number(data.total_cost).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('pnl').innerText = Number(data.p_and_l).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('percent').innerText = Number(data.percent).toFixed(2);

      const pnlElem = document.getElementById('pnl');
      pnlElem.style.color = data.p_and_l < 0 ? 'red' : 'green';

      const percentElem = document.getElementById('percent');
      percentElem.style.color = data.percent < 0 ? 'red' : 'green';

      document.getElementById('pageInfo').innerText = `Page ${data.pagination.current_page} / ${data.pagination.num_pages}`;
    })
    .catch(err => {
      console.error(err);
      alert('Failed to load stock report');
    });
}
</script>
{% endblock %}
