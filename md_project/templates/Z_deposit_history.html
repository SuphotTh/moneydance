{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Deposit History{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">Deposit History (THB)</h3>

  <!-- Exchange Selection -->
  <div class="mb-3">
    <label for="exchangeSelect" class="form-label"><strong>Select Exchange:</strong></label>
    <select id="exchangeSelect" class="form-select">
      <option value="bitkub" selected>Bitkub</option>
      <option value="binanceth">BinanceTh</option>
    </select>
  </div>

  <!-- Data Table -->
  <table class="table table-striped mt-3">
  <thead>
    <tr>
      <th>Txn ID</th>
      <th>Currency</th>
      <th>Amount (THB)</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
    {% if deposits %}
      {% for item in deposits %}
        <tr>
          <td>{{ item.txn_id }}</td>
          <td>{{ item.currency }}</td>
          <td>{{ item.amount|intcomma }}</td>
          <td>{{ item.status }}</td>
          <td>{{ item.time|date:"Y-m-d H:i:s" }}</td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted">No deposit data found</td>
      </tr>
    {% endif %}
  </tbody>
</table>


  <!-- Pagination Info -->
  <div id="paginationInfo" class="mt-2 text-end text-muted"></div>
</div>

<script>
function loadDepositData(exchange) {
  const tableBody = document.querySelector("#depositTable tbody");
  const paginationDiv = document.getElementById("paginationInfo");
  tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-info">Loading...</td></tr>`;
  paginationDiv.textContent = '';

  fetch(`/deposit_history_${exchange}/`)
    .then(response => response.json())
    .then(data => {
      if (data.error !== 0 || !data.result || data.result.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">No deposit data found</td></tr>`;
        return;
      }

      let rows = "";
      data.result.forEach(item => {
        const date = new Date(item.time * 1000).toLocaleString();
        rows += `
          <tr>
            <td>${item.txn_id}</td>
            <td>${item.currency}</td>
            <td>${item.amount.toLocaleString()}</td>
            <td>${item.status}</td>
            <td>${date}</td>
          </tr>`;
      });
      tableBody.innerHTML = rows;

      // Show pagination info if available
      if (data.pagination) {
        paginationDiv.textContent = `Page ${data.pagination.page} of ${data.pagination.last}`;
      }
    })
    .catch(err => {
      console.error(err);
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>`;
    });
}

// Load Bitkub deposits by default on page load
document.addEventListener("DOMContentLoaded", function() {
  loadDepositData("bitkub");
});

// Exchange selection listener
document.getElementById("exchangeSelect").addEventListener("change", function() {
  loadDepositData(this.value);
});
</script>
{% endblock %}
